name: Codex write code

on:
  workflow_dispatch:
    inputs:
      task:
        description: What to implement
        required: true
        type: string
      model:
        description: OpenAI API Model
        required: true
        default: codex-mini-latest
        type: string
      base_branch:
        description: Branch to branch off from
        required: true
        default: main
        type: string

jobs:
  write_code:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: latest

      - name: Install Codex CLI
        run: npm i -g @openai/codex

      - name: Authenticate Codex CLI using OpenAI API key
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: printenv OPENAI_API_KEY | codex login --with-api-key

      - name: Implement change with Codex
        run: codex --yolo --model "${{ inputs.model }}" exec "${{ inputs.task }}"

      - name: Commit changes and open pull request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "codex/${{ github.run_id }}"
          git add -A
          git diff --cached --quiet && exit 0
          git commit -m "Codex: ${{ inputs.task }}"
          git push --set-upstream origin "codex/${{ github.run_id }}"
          gh pr create --base "${{ inputs.base_branch }}" --head "codex/${{ github.run_id }}" --title "Codex: ${{ inputs.task }}" --body "Automated changes generated by Codex CLI."
